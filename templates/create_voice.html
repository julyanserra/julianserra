{% extends "layout.html" %}
{% block content %}
            
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">


        <!-- add padding so the content doesn't touch the edges of the screen -->
        <br><br>
        <main id="content" class="bg-white rounded-lg shadow p-6 mb-8">
            <div id="notification" class="mb-4 p-4 rounded hidden"></div>
            <form id="aiVoiceForm" class="space-y-4">
                <div>
                    <label for="voice_name" class="block text-gray-700 text-sm font-bold mb-2">Voice Name</label>
                    <input type="text" id="voice_name" name="voice_name" required class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                </div>
                <div>
                    <label for="voice_photo" class="block text-gray-700 text-sm font-bold mb-2">Voice Photo URL</label>
                    <input type="url" id="voice_photo" name="voice_photo" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                </div>
                <div>
                    <label for="voice_prompt" class="block text-gray-700 text-sm font-bold mb-2">Voice Prompt</label>
                    <textarea id="voice_prompt" name="voice_prompt" rows="3" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"></textarea>
                </div>
                <div>
                    <label class="block text-gray-700 text-sm font-bold mb-2">Voice Recording</label>
                    <div class="flex items-center space-x-2">
                        <button type="button" id="recordButton" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">
                            Start Recording
                        </button>
                        <audio id="audioPlayback" controls class="hidden"></audio>
                    </div>
                </div>
                <div class="flex items-center justify-between">
                    <button type="submit" class="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline w-full">
                        Submit
                    </button>
                </div>
            </form>
        </main>

        
{% endblock %}
    
</body>
</html>

{% block scripts %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/lamejs/1.2.0/lame.min.js"></script>
<script>
        let mediaRecorder;
        let audioChunks = [];
        const recordButton = document.getElementById('recordButton');
        const audioPlayback = document.getElementById('audioPlayback');
        const form = document.getElementById('aiVoiceForm');
        const notification = document.getElementById('notification');
        recordButton.addEventListener('click', toggleRecording);

        async function convertToMp3(audioChunks) {
    const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
    const audioBuffer = await audioContext.decodeAudioData(await audioBlob.arrayBuffer());
    
    const channelData = audioBuffer.getChannelData(0);
    const samples = new Int16Array(channelData.length);
    for (let i = 0; i < channelData.length; i++) {
        samples[i] = channelData[i] < 0 ? channelData[i] * 0x8000 : channelData[i] * 0x7FFF;
    }

    const mp3Encoder = new lamejs.Mp3Encoder(1, audioBuffer.sampleRate, 128);
    const mp3Chunks = [];

    const maxSamples = 1152;
    for (let i = 0; i < samples.length; i += maxSamples) {
        const chunk = samples.subarray(i, i + maxSamples);
        const mp3buf = mp3Encoder.encodeBuffer(chunk);
        if (mp3buf.length > 0) {
            mp3Chunks.push(mp3buf);
        }
    }

    const mp3buf = mp3Encoder.flush();
    if (mp3buf.length > 0) {
        mp3Chunks.push(mp3buf);
    }

    return new Blob(mp3Chunks, { type: 'audio/mp3' });
}


        async function toggleRecording() {
            if (mediaRecorder && mediaRecorder.state === 'recording') {
                mediaRecorder.stop();
                recordButton.textContent = 'Start Recording';
                recordButton.classList.remove('bg-red-500', 'hover:bg-red-700');
                recordButton.classList.add('bg-blue-500', 'hover:bg-blue-700');
            } else {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream, { mimeType: 'audio/webm' });
                mediaRecorder.ondataavailable = event => {
                    audioChunks.push(event.data);
                };
                mediaRecorder.onstop = () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                    const audioUrl = URL.createObjectURL(audioBlob);
                    audioPlayback.src = audioUrl;
                    audioPlayback.classList.remove('hidden');
                };
                audioChunks = [];
                mediaRecorder.start();
                recordButton.textContent = 'Stop Recording';
                recordButton.classList.remove('bg-blue-500', 'hover:bg-blue-700');
                recordButton.classList.add('bg-red-500', 'hover:bg-red-700');
            }
        }

        function showNotification(message, isError = false) {
            notification.textContent = message;
            notification.classList.remove('hidden', 'bg-green-100', 'text-green-700', 'bg-red-100', 'text-red-700');
            notification.classList.add(isError ? 'bg-red-100' : 'bg-green-100', isError ? 'text-red-700' : 'text-green-700');
            notification.scrollIntoView({ behavior: 'smooth' });
        }



    form.addEventListener('submit', async function (e) {
        e.preventDefault();
        const formData = new FormData(form);

        if (audioChunks.length === 0) {
            showNotification('Please record audio before submitting.', true);
            return;
        }

        // Convert WebM to MP3
        const mp3Blob = await convertToMp3(audioChunks);

        // Add the MP3 audio file to the FormData
        formData.append('audio', mp3Blob, 'recording.mp3');

        try {
            const response = await fetch('/process_voice', {
                method: 'POST',
                body: formData
            });
            const result = await response.json();
            if (response.ok) {
                showNotification('Voice processed successfully!');
                form.reset();
                audioPlayback.src = '';
                audioPlayback.classList.add('hidden');
                audioChunks = [];
            } else {
                showNotification(result.error || 'An error occurred while processing the voice.', true);
            }
        } catch (error) {
            showNotification('An error occurred while submitting the form.', true);
            console.error('Error:', error);
        }
    });
</script>

{% endblock %}

  
</body>
</html>